---
title: "데이터 가공과 시각화"
output:
  html_document:
    toc: yes
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

## Preparations  

dplyr 와 gapminder 패키지를 설치하고, 로딩합니다.  

```{r eval=FALSE}
install.packages("dplyr")
install.packages("gapminder")
```

```{r message=FALSE}
library(dplyr)
library(gapminder)
```

[Note]  
R에서 패키지(package)는 함수, 데이터, 코드, 문서 등을 묶어놓은 것을 말합니다. R을 설치하면 자동으로 기본 패키지들이 설치되는데, 이들이 제공하지 못하는 기능들은 새로운 패키지를 설치해서 사용합니다. 현재 10,000여개 이상의 패키지들이 CRAN, Bioconductor, GitHub 등의 repository에 저장되어 있습니다.     
[R packages: Beginner's Guide](https://www.datacamp.com/community/tutorials/r-packages-guide#what)  


## 데이터 가공(Data wrangling)   
the process of transforming and mapping data from one "raw" data form into another format with the intent of making it more appropriate and valuable for a variety of downstream purposes such as analytics.  

### Learning Objectives

- Select columns in a data frame with the dplyr function select.  
- Select rows in a data frame according to filtering conditions with the dplyr function filter.  
- Direct the output of one dplyr function to the input of another function with the ‘pipe’ operator %>%.  
- Add new columns to a data frame that are functions of existing columns with mutate.  
- Understand the split-apply-combine concept for data analysis.
Use summarize, group_by, and tally to split a data frame into groups of observations, apply a summary statistics for each group, and then combine the results.  

### gapminder 데이터셋 둘러보기
gapminder 데이터는 국가별 년도별 life expectancy, GDP per capita, 그리고 population에 대한 데이터입니다.  

```{r}
head(gapminder)
str(gapminder)
summary(gapminder)
```

### filter

조건에 맞는 관측치만 골라내기
```{r warning=FALSE}
gapminder %>%
  filter(year == 1957)
```

```{r}
gapminder %>%
  filter(country == "Korea, Rep.")
```

### arrange

오름차순
```{r}
gapminder %>%
  arrange(gdpPercap)
```
<br>

내림차순
```{r}
gapminder %>%
  arrange(desc(gdpPercap))
```

### mutate

백만명단위로 인구수 변환
```{r}
gapminder %>%
  mutate(pop = pop/1000000)
```
<br>

총국민소득 구하기
```{r}
gapminder %>%
  mutate(gdp = gdpPercap*pop)
```

## 데이터 요약(Summary)

### summarize

2007년의 평균 기대수명 
```{r}
gapminder %>%
  filter(year == 2007) %>%
  summarize(meanLifeExp = mean(lifeExp))
```
<br>

2007년의 평균 기대수명과 총인구수 
```{r}
gapminder %>%
  filter(year == 2007) %>%
  summarise(meanLifeExp = mean(lifeExp), totPop = sum(as.numeric(pop))) # integer overflow, 2*10^9
```

### group_by

년도별 평균 기대수명 
```{r}
gapminder %>%
  group_by(year) %>%
  summarise(meanLifeExp = mean(lifeExp))
```
<br>

년도별 대륙별 평균 기대수명 
```{r}
gapminder %>%
  group_by(continent, year) %>%
  summarize(meanLifeExp = mean(lifeExp))
```

## 데이터 시각화(Data visualization)

> "Visualization is any technique for creating images, diagrams, or animations to communicate a message" - Wikipedia 

> "One picture is worth ten thousand words"

> "백수이불여일화 百數以不如一畵"

> “The simple graph has brought more information to the data analyst’s mind than any other device.” — John Tukey

load ggplot2
```{r message=FALSE}
library(ggplot2)
```
<br>

ggplot2  
- by Hadley Wickham  
- based on "Grammar of Graphics" (그래픽의 각 요소를 구분하여 취급)  
- incremental method (기초 플롯을 생성한 후, 필요한 그래픽 요소들을 붙이는 방식)   

### scatter plot

scatter plot: gdpPercap vs. lifeExp in year 2007  
2007년 1인당 국민소득과 기대수명의 관계를 산점도로 그리기  

```{r}
gapminder_2007 <- gapminder %>%
  filter(year == 2007) 
```

```{r}
ggplot(data = gapminder_2007, aes(x=gdpPercap, y=lifeExp)) + geom_point()
```

### additional aesthetics
그래픽 요소(color, size)에 데이터를 매핑
```{r}
ggplot(data = gapminder_2007, aes(x=gdpPercap, y=lifeExp, color=continent, size=pop)) + geom_point()
```

### faceting 

```{r}
ggplot(data = gapminder_2007, aes(x=gdpPercap, y=lifeExp)) + 
  geom_point() + 
  facet_wrap(~continent)
```



### line plot

대륙별로 평균 기대수명의 연도에 따른 변화를 보자. 
```{r}
year_continent = gapminder %>%
  group_by(continent, year) %>%
  summarize(meanLifeExp = mean(lifeExp))
p = ggplot(data = year_continent, aes(x=year, y=meanLifeExp, color=continent)) + geom_point()
p = p + geom_line()
p
p + expand_limits(y=0) 
```

2007년 1인당 국민소득과 기대 수명의 관계를 산점도로 그리고, 선형 회귀직선을 그려보자. 
```{r}
p <- ggplot(gapminder_2007, aes(gdpPercap, lifeExp)) + geom_point()
p
p = p + scale_x_log10() # scale 함수 
p
```

```{r}
gapminder_2007_coef = coef(lm(lifeExp ~ log10(gdpPercap), data = gapminder_2007))
gapminder_2007_coef
```

```{r}
p + geom_abline(intercept = gapminder_2007_coef["(Intercept)"], 
                slope = gapminder_2007_coef["log10(gdpPercap)"], color = "red")
```

통계적 데이터의 변환 함수를 이용하자. 
```{r}
p
p + stat_smooth(method = "lm", se=F, color = "red") 
```

### bar plot

대륙별 평균 기대수명의 비교. (bar plot)
```{r}
by_continent = gapminder %>%
  group_by(continent) %>%
  summarise(meanLifeExp = mean(lifeExp))
ggplot(by_continent, aes(x=continent, y=meanLifeExp)) + geom_col()
```

### histogram 

기대수명의 분포 (histogram)
```{r}
ggplot(gapminder, aes(x=lifeExp)) + geom_histogram()
```
<br>

5년 단위 구간(bins)
```{r}
ggplot(gapminder, aes(x=lifeExp)) + geom_histogram(binwidth = 5)
```

### box plot

대륙별 기대수명의 분포 비교 (box plot)
```{r}
ggplot(gapminder, aes(x=continent, y=lifeExp)) + geom_boxplot()
```
<br>

### ggplot2 plot 의 기본 성분과 구조

ggplot2 plot의 기본 성분  
- Data: 주로 data frame 객체 형태의 데이터
- Aesthetic mappings: 데이터를 축, 색상, 점의 크기 등으로 매핑하는 방법
- Geometric object: 점, 선, 도형과 같은 기하학적 객체
- Scales: 
- Coordinate system: 좌표계
- Facetting: 조건부 플롯을 위해 패널을 분할하여 표현하는 방법
- Statistical transformation: Binning, quantiles, smoothing 등의 통계 변환 
- Position adjustment: 위치의 조정 

```{r}
p <- ggplot(data = gapminder_2007, aes(x=gdpPercap, y=lifeExp)) + geom_point()
attributes(p)
summary(p)
```
<br>

ggplot2 plot 의 구조  
- ggplot = layers + scales + coordinate system 
- layers = data + mapping + geom + stat + position 


### ggplot2 함수군

- Plot creation: ggplot 클래스 객체를 생성하는 함수군
- Geoms: graphic 의 geometric (기하학적인 형태)을 지정하는 함수군
- Statistics: 데이터를 통계적인 관점으로 변환하는 함수군
- Scales: 축의 스케일 변환과 라벨, 범례 등을 변경하는 함수군
- Coordinate systems: 좌표계를 설정하는 함수군
- Faceting: 그래픽 facet layout 을 정의하는 함수군
- Position adjustment: geometric 의 위치를 지정하는 함수군
- Others

```{r}
apropos("^geom_")
```

```{r}
apropos("^stat_")
```






